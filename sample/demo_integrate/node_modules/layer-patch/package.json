{
  "name": "layer-patch",
  "version": "0.1.0",
  "main": "js/layer-patch.js",
  "gitHead": "573a2da30c1aeb1b26b345b4d9ccc4005cba9e3c",
  "readme": "# The Layer-Patch Format\n\n\n## Introduction\n\nWhat is Layer-Patch, and why use it rather than industry standard formats?\n\nLayer-Patch is a format for communicating changes to objects between multiple devices/services so that all devices can maintain a common object state.\n\nIt is similar in many ways to the JSON-Patch standard. The JSON-Patch standard had a few key flaws:\n\n1. It has a concept of arrays, but no concept of sets.\n2. Small changes in the ordering of the array, or in the sequence in which syncing is done will cause objects to get out of sync, resulting in bad behaviors.  Such issues may be easily addressed in a tight-knit set of teams and environments, but will result in many errors when used to communicate with a wide variety of customers using a wide variety of frameworks.\n3. It uses JSON Pointer notation (path elements seperated by \"/\") inconsistent with a variety of standard practices based around path elements being separated by \".\".\n\n> Note that this document uses examples from data models used by Layer, Inc.  The format described here however should be applicable to any domain.\n\n> The term \"Base Object\" refers to a core resource that can be mutated via patch operations.  Examples in this document will use Conversation and Message objects used by Layer, Inc.\n\n> Note that there may be occasional notes in the document, formatted like this.  They will be used to indicate the current state of implementation of the format, and should not be considered a part of the specification itself.\n\n## The Format\n\n    Content-type: application/vnd.layer-patch+json\n\n    [\n        {operation: \"add\",      property: \"propA.propB\", value: \"fred\"},\n        {operation: \"remove\",   property: \"propA.propB\", value: \"fred\"},\n        {operation: \"add\",      property: \"propA.propB\", value: \"fred\", index: 3},\n        {operation: \"remove\",   property: \"propA.propB\", value: \"fred\", index: 3},\n        {operation: \"remove\",   property: \"propA.propB\", index: 3},\n        {operation: \"set\",      property: \"propA.propB\", value: \"fred\"},\n        {operation: \"delete\",   property: \"propA.propB\"},\n        {operation: \"set\",      property: \"propA.propB\", id: \"layer:///messages/uuid\"}\n    ]\n\n\nThe above structure shows the Operations Array, which consists of an array of operations to be executed in sequence, each operation modifying the specified resource.\n\n### Using the Operations Array via REST API\n\nA REST call will identify the resource to be modified via the URL of the request.  The call will provide\n\n1. A \"Content-Type\" header of \"application/vnd.layer-patch+json\".\n2. A request body that consists of the Operations Array.\n\n\n```\nPATCH /conversations/{conversation_id}\nContent-type: \"application/vnd.layer-patch+json\"\n\n[\n    {operation: \"add\",      property: \"participants\", value: \"user1\"},\n    {operation: \"add\",      property: \"participants\", value: \"user2\"},\n    {operation: \"remove\",   property: \"participants\", value: \"user3\"}\n]\n```\n\n### Using the Operations Array via Websocket API\n\nA Websocket event will identify the resource to be modified and will provide an Operations Array to tell the client or server how to update that resource.  Here is one example:\n\n    {\n        \"type\": \"change\",\n        \"operation\": \"patch\",\n        \"object\": {\n            \"type\": \"Conversation\",\n            \"id\": \"layer:///conversations/f3cc7b32-3c92-11e4-baad-164230d1df67\",\n            \"url\": \"https://api.layer.com/conversations/f3cc7b32-3c92-11e4-baad-164230d1df67\"\n        },\n        \"data\": [\n            {operation: \"delete\", property: \"metadata.todo\"},\n            {operation: \"set\",    property: \"unread_message_count\", 5}\n        ]\n    }\n\n### The Operations Array\n\nThe operations array can contain zero or more elements. Each element represents an Operation\n\nEach Operation consists of the following keys:\n\n* operation: Type of mutation to perform (required)\n* property: Path to the property to modify (required)\n* value: Value to be added or removed from the property\n* id: Id of the object to be added or removed from the property\n* index: Index in an array of a value to insert or remove\n\n#### The Operation Key\n\nThe following values are supported for `operation`:\n\n* add: Adds the specified value to an array/set.\n* remove: Removes the specified value from an array/set.\n* set: Sets the specified key in an object.\n* delete: Removes the specified key from an object.\n\n#### The Property Key\n\nA property identifies either a property of the Base Object or a `.` separated path to a key within one of its properties.\n\n* `unread_message_count`: Identifies the unread_message_count property of a Base Object.\n* `recipient_status.fred`: Identifies the recipient_status property of a Base Object, and the `fred` key within the recipient_status value.\n\nAny key within an object identified by the `property` that does not exist will be created.  Note however:\n\n* New properties will never be created on a Base Object, only within object/dictionary properties of the Base Object.\n* This rule *does* apply to the `delete` operation; refering to \"metadata.a.b.c\" means that `metadata: {a: {b: {c: null}}` must be created so that b can be deleted; thus, `{a: {b: {}}}` may be created in order to delete \"metadata.a.b.c\". (note: the creation of the structure is the goal, implementation details are not intended to be mandated here).\n\n##### Escaping Periods\n\nThere is a special case where a property name has a \".\" in the name:\n```\n{\n    recipient_status: {\n        \"fred.flinstone\": \"read\"\n    }\n}\n```\nThe path \"recipient_status.fred.flinstone\" will actually assume the following structure:\n```\n{\n    recipient_status: {\n        \"fred\": {\n            \"flinstone\": \"read\"\n        }\n    }\n}\n```\n\nTo process a \".\" inside of a property name use \"..\": \"recipient_status.fred..flinstone\" would be the correct property name for accessing the recipient_status of \"fred.flinstone\".\n\n#### The Value and Id Key\n\nAll operations except delete take either a `value` or a `id`.  `value` or `id` specify what value is to be written or removed from the property.  `value` passes the value directly while `id` identifies an object to be passed in.\n\n#### The Index Key\n\nThe `index` property is used to modify the `add` and `remove` operations.\n\n* Omitting the `index` will result in `add` and `remove` performing *set* rather than *array* operations.  As such, `add` will not add a second copy of a value and `remove` will only remove by value.\n* `add` by `index` will cause the specified value to be *inserted*.  If the goal is to *replace* the previous value, then you must first perform a `remove` operation.\n* `remove` by `index` removes the value at the specified array index.\n* `remove` by `index` with a `value` or `id` as part of the operation will only remove the specified index from the array if the value at that index matches the value from the operation.\n\n> Support for `index` and array manipulation is not yet implemented in any frameworks\n\n## Details\n\n\n### The `set` operation\n\nOne can directly set a property.\n\nInitial State:\n\n    unread_message_count: 100\n\nSet it to 5:\n\n    [{\n        operation: \"set\",\n        property: \"unread_message_count\",\n        value: 5\n    }]\n\nFinal State:\n\n    unread_message_count: 5\n\nOne can also set an embedded property:\n\nInitial State:\n\n    recipient_status: {\n        fred: \"sent\",\n        sue: \"sent\"\n    }\n\nChange fred to \"read\":\n\n    [{\n        operation: \"set\",\n        property: \"recipient_status.fred\",\n        value: \"read\"\n    }]\n\nFinal State:\n\n    recipient_status: {\n        fred: \"read\",\n        sue: \"sent\"\n    }\n\n\nFinally, while `add` and `remove` can only work on arrays, `set` if used on an array will replace the entire array with a new value.\n\nInitial State:\n\n    participants: [\"mary\", \"joe\"]\n\nReplace the list:\n\n    [{\n        operation: \"set\",\n        property: \"participants\",\n        value: [\"fred\", \"sue\"]\n    }]\n\nFinal State:\n\n    participants: [\"fred\", \"sue\"]\n\n#### Setting using `id`\n\nInstead of providing a value, one could provide an `id` that identifies a resource.\n\nInitial State:\n\n    last_message: null\n\nSet the value by id\n\n    [{\n        operation: \"set\",\n        property: \"last_message\",\n        id: \"layer:///messages/uuid\"\n    }]\n\nWhile processing this can be done simply by setting `last_message = \"layer:///messages/uuid\"`, the expectation is that developers will use the `id` value as a hint to lookup the ID in their object cache and set last_message to an object:\n\n    conversation.last_message = lookupObject(\"layer:///messages/uuid\");\n\nFinal State:\n\n    last_message: {\n        id: \"layer:///messages/uuid\",\n        url: \"https://api.layer.com/messages/uuid\",\n        parts: [...]\n    }\n\nNote that this version of the specification does not describe how to lookup objects, nor how to match an object by Id.  This is presumed to be custom to each object type.\n\n### The `delete` operation\n\nThe delete operation will remove the specified key from the object.  Notes:\n\n* It is *invalid* to delete a property of a Base Object (e.g. Message.recipient_status, Conversation.unread_message_count, etc...).  Instead use the `set` operation with a `value` of *null*.\n* It is *valid* to delete a key within an object/dictionary stored in a Base Object's property. (e.g Conversation.metadata.fred).\n* Delete has the same meaning as removing a key from a Hash: it removes the key from the object along with any/all data it references.\n\nInitial State:\n\n    recipient_status: {\n        fred: \"read\",\n        sue: \"sent\"\n    }\n\nRemove fred:\n\n    [{\n        operation: \"delete\",\n        property: \"recipient_status.fred\"\n    }]\n\nFinal State:\n\n    recipient_status: {\n        sue: \"sent\"\n    }\n\n\n\n### The `add` Operation\n\n\n`add` is used solely for operating upon array properties. `add` takes a value and adds it to the target property array.\n\n#### Using `add` for Operations on Sets\n\nAn `add` Operation that omits the `index` property will use Set logic when adding values.\n\n**Add to Set means that the specified value will be added to the array.**\n\nInitial State:\n\n    participants: [\"mary\", \"joe\"]\n\nAdds \"fred\" and \"sue\" to the participants array\n\n    [{\n        operation: \"add\",\n        property: \"participants\",\n        value: \"fred\"\n    },\n    {\n        operation: \"add\",\n        property: \"participants\",\n        value: \"sue\"\n    }]\n\nFinal State:\n\n    participants: [\"mary\", \"joe\", \"fred\", \"sue\"]\n\n**Add to Set means that if the value is already there, its a no-op.**\n\nInitial State:\n\n    participants: [\"mary\", \"joe\"]\n\nAdds \"mary\" and \"sue\" to the participants array:\n\n    [{\n        operation: \"add\",\n        property: \"participants\",\n        value: \"mary\"\n    },\n    {\n        operation: \"add\",\n        property: \"participants\",\n        value: \"sue\"\n    }]\n\nFinal State:\n\n    participants: [\"mary\", \"joe\", \"sue\"]\n\n**Until the spec evolves to define how to compare two objects, adding objects to sets will not work.**\n\n    [{\n        operation: \"add\",\n        property: \"metadata.myobject\",\n        value: {my: \"object\"}\n    }]\n\nWill throw an error.  \n\n**Until the spec evolves to define how to compare two Sets or Arrays, adding Arrays or Sets will not work.**\n\n    [{\n        operation: \"add\",\n        property: \"participants\",\n        value: [\"fred\", \"sue\"]\n    }]\n\nWill throw an error.  \n\n**An exception to adding objects: adding values by id is supported as it provides a clear way to compare objects.**\n\nInitial State:\n\n    metadata: {\n        linked_messages: [\n            {id: \"layer:///messages/id1\", ...},\n            {id: \"layer:///messages/id2\", ...},\n            {id: \"layer:///messages/id3\", ...}\n        ]\n    }\n\nAdd Messages with id2 and id5:\n\n    [{\n        operation: \"add\",\n        property: \"metadata.linked_messages\",\n        id: \"layer:///messages/id2\"\n    }, {\n        operation: \"add\",\n        property: \"metadata.linked_messages\",\n        id: \"layer:///messages/id5\"\n    }]\n\nFinal State:\n\n    metadata: {\n        linked_messages: [\n            {id: \"layer:///messages/id1\", ...},\n            {id: \"layer:///messages/id2\", ...},\n            {id: \"layer:///messages/id3\", ...},\n            {id: \"layer:///messages/id5\", ...}\n        ]\n    }\n\nNote that id2 was not added as it was already present.\n\n**As explained in (Property) [#property], a missing property will be created.  For the `add` Operation, it will be created as an array.**\n\nInitial State:\n\n    metadata: {}\n\nAdd \"mary\" to metadata.a.b.c:\n\n    [{\n        operation: \"add\",\n        property: \"metadata.a.b.c\",\n        value: \"mary\"\n    }]\n\nFinal State:\n\n    metadata: {\n        a: {\n            b: {\n                c: [\"mary\"]\n            }\n        }\n    }\n\n#### Using `add` in Array Operations\n\nProviding an `index` property causes this operation to be treated as an array operation rather than a set operation.\n\nInterpreting Index:\n\n* 0: Insert the value at the start of the array, shifting all other values back.  This does NOT overwrite the value at index 0.\n* 5: Insert the value into the middle of the array, at index 5.\n* -1: Push the value at the end of the array\n\nBecause this is an array operation, it will add the same value multiple times.\n\nInitial State:\n\n    participants: [\"mary\"]\n\nAdd \"mary\" and \"joe\" to the  participant list:\n\n    [{\n        operation: \"add\",\n        property: \"participants\",\n        value: \"mary\",\n        index: \"-\"\n    },\n    {\n        operation: \"add\",\n        property: \"participants\",\n        value: \"joe\",\n        index: 0\n    }]\n\nFinal State:\n\n    participants: [\"joe\", \"mary\", \"mary\"]\n\nObviously for participants, we'd want to treat it as a Set rather than as an Array.\n\n> At this time, only set, and not array behaviors are implemented in the code in this repository.\n\n### The `remove` operation\n\n`remove` is used solely for operating upon array properties.  `remove` takes a value and removes it from the target property array.\n\n#### Using `remove` for Operations on Sets\n\nA `remove` Operation that omits the index property will use Set logic when removing values.\n\n**Remove from Sets means that the specified value will be removed from the array.**\n\nInitial State:\n\n    participants: [\"mary\", \"joe\", \"sue\", \"fred\"]\n\nRemove \"fred\" and \"sue\" from the participants array:\n\n    [{\n        operation: \"remove\",\n        property: \"participants\",\n        value: \"fred\"\n    },\n    {\n        operation: \"remove\",\n        property: \"participants\",\n        value: \"sue\"\n    }]\n\nFinal State:\n\n    participants: [\"mary\", \"joe\"]\n\n**Remove from Set means that if the value is not found, its a no-op, not an error.**\n\nInitial State:\n\n    participants: [\"mary\", \"joe\", \"sue\", \"fred\"]\n\nRemove \"fred\" and \"Zod\" from the participants array:\n\n    [{\n        operation: \"remove\",\n        property: \"participants\",\n        value: \"fred\"\n    },\n    {\n        operation: \"remove\",\n        property: \"participants\",\n        value: \"Zod\"\n    }]\n\nFinal State:\n\n    participants: [\"mary\", \"sue\", \"joe\"]\n\nThe absense of a \"Zod\" does not affect successful completion of all operations in the Operations Array.\n\n**Until the spec evolves to define how to compare two objects, removing objects from sets will not work.**\n\n    [{\n        operation: \"remove\",\n        property: \"metadata.myarray\",\n        value: {hey: \"ho\"}\n    }]\n\nWill throw an error.\n\n**Until the spec evolves to define how to compare two Sets or Arrays, removing Arrays or Sets will not work.**\n\n    [{\n        operation: \"remove\",\n        property: \"participants\",\n        value: [\"fred\", \"sue\"]\n    }]\n\nWill throw an error.\n\n**An exception to removing objects: removing values by id is supported as it provides a clear way to compare objects.**\n\nInitial State:\n\n    metadata: {\n        linked_messages: [\n            {id: \"layer:///messages/id1\", ...},\n            {id: \"layer:///messages/id2\", ...},\n            {id: \"layer:///messages/id3\", ...}\n        ]\n    }\n\nRemove id2 from metadata.linked_messages:\n\n    [{\n        operation: \"remove\",\n        property: \"metadata.linked_messages\",\n        id: \"layer:///messages/id2\"\n    }]\n\nFinal State:\n\n    metadata: {\n        linked_messages: [\n            {id: \"layer:///messages/id1\", ...},\n            {id: \"layer:///messages/id3\", ...}\n        ]\n    }\n\n**As explained in (Property) [#property], a missing property will be created.  For the `remove` Operation, it will be created as an Array.**\n\nInitial State:\n\n    metadata: {}\n\nRemove \"mary\" from metadata.a.b.c:\n\n    [{\n        operation: \"remove\",\n        property: \"metadata.a.b.c\",\n        value: \"mary\"\n    }]\n\nFinal State:\n\n    metadata: {\n        a: {\n            b: {\n                c: []\n            }\n        }\n    }\n\n#### Using `remove` in Array Operations\n\nProviding an `index` value will treat this as an array Operation.\n\nInterpreting Index:\n\n* 0:Remove the value at the start of the array.\n* 5: Remove the value at index 5 of the array.\n* -1: Remove the last value from the array.\n\nInitial State:\n\n    participants: [\"mary\", \"joe\", \"Zod\"]\n\nRemove the second element:\n\n    [{\n        operation: \"remove\",\n        property: \"participants\",\n        index: 1\n    }]\n\nFinal Result:\n\n    participants: [\"mary\", \"Zod\"]\n\nNote that operations are executed in the order specified. Thus the following will remove the first and third elements, rather than the first and second elements:\n\n    [{\n        operation: \"remove\",\n        property: \"participants\",\n        index: 0\n    }, {\n        operation: \"remove\",\n        property: \"participants\",\n        index: 1\n    }]\n\n\n> At this time, only set, and not array behaviors are implemented in the code in this repository.\n\n##### Using `value` with `index`\n\nProviding an `index` and a `value` will remove the value at the specified index IF it matches the specified value.\n\nInitial State:\n\n    participants: [\"mary\", \"joe\", \"Zod\"]\n\nRemove the first and second elements:\n\n    [{\n        operation: \"remove\",\n        property: \"participants\",\n        index: 1,\n        value: \"Zod\"\n    }, {\n        operation: \"remove\",\n        property: \"participants\",\n        index: 0,\n        value: \"mary\"\n    }]\n\nFinal Result:\n\n    participants: [\"joe\", \"Zod\"]\n\nNote that \"joe\" at index 1 was not removed because it did not match the value \"Zod\".  The fact that \"joe\" moved after the second operation, does not get taken into account.\n\nAlso note that operations are executed in the order specified. Thus the following operation would be hazardous:\n\n    [{\n        operation: \"remove\",\n        property: \"participants\",\n        index: 0,\n        value: \"Zod\"\n    }, {\n        operation: \"remove\",\n        property: \"participants\",\n        index: 1\n    }]\n\nDepending on whether the first value is \"Zod\", the operation will either remove the first and third elements of the array, or the second element of the array.  This can be addressed with correctly sequenced operations (an array of operations operates upon array indexes in reverse index order).\n\n## Examples\n\n### Managing Active Participants\n\nThe scenario below assumes that we start with the following metadata for managing which participants are actively posting to a Conversation.\n\n    {\n        active_participants: [\"fred\", \"sue\"],\n        inactive_participants: {\n            \"mary\": \"2014-09-09T04:44:47+00:00\",\n            \"john\": \"2014-09-10T08:88:87+00:00\"\n        }\n    }\n\nWe should be able to move mary from an inactive_participant to an active_participant.\n\n    [{\n        operation: \"add\",\n        property: \"metadata.active_participants\",\n        value: \"mary\"\n    },\n    {\n        operation: \"delete\",\n        property: \"inactive_participants.mary\"\n    }]\n\nOr undo it with:\n\n    [{\n        operation: \"remove\",\n        property: \"metadata.active_participants\",\n        value: \"mary\"\n    },\n    {\n        operation: \"set\",\n        property: \"metadata.inactive_participants.mary\",\n        value: \"2014-09-09T04:44:47+00:00\"\n\n    }]\n\n### Managing Links Between Conversations\n\nSlack has a nice feature where you can post a URL to a message in another conversation.  How would that be accomplished using \"patch\" operations on metadata?\n\nInitial State:\n\n    metadata: {}\n\nThe Operation:\n\n    [{\n        operation: \"set\",\n        property: \"metadata.linked_message\",\n        id: \"layer:///messages/940de862-3c96-11e4-baad-164230d1df67\"\n    }]\n\nFinal State:\n\n    metadata: {\n        linked_message: {\n            id: \"layer:///messages/940de862-3c96-11e4-baad-164230d1df67\",\n            url: \"https://api.layer.com/messages/940de862-3c96-11e4-baad-164230d1df67\",\n            parts: [...]\n        }\n    }\n\nSuch an operation could be used to repeatedly update what messages/conversations are being pointed to by that property.\n\n## Future Work\n\nThe following have been left out of the spec but may be added in the future for consistency:\n\n1. Actual implementation of array operations is not expected for early implementations of this spec.\n2. Handling Objects, Arrays and Sets when adding or removing values from Sets: In order to do this, we need to have a platform-agnostic way of signaling the equivalency of two objects, arrays or sets.\n3. More concise syntax.  It should be possible to add 100 values to an array without 100 operations.\n4. More detail should be provided on how add and remove by \"id\" actually match by \"id\".\n\n## License\n\nLayer-Patch is available under the Apache 2 License. See the LICENSE file for more info.\n",
  "readmeFilename": "README.md",
  "description": "",
  "_id": "layer-patch@0.1.0",
  "_shasum": "c43e73294368e90a294f7232ce64061fa787fc5c",
  "_from": "git://github.com/layerhq/layer-patch.git",
  "_resolved": "git://github.com/layerhq/layer-patch.git#573a2da30c1aeb1b26b345b4d9ccc4005cba9e3c",
  "_fromGithub": true
}
